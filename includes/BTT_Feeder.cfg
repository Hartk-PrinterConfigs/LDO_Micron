[gcode_macro HUB_STATUS]
gcode:
  {action_call_remote_method("openfeeder_hub_status")}


[gcode_macro OPENFEEDER_STATUS]
gcode:
  {action_call_remote_method("openfeeder_status")}


[gcode_macro OPENFEEDER_MOVE]
gcode:
  {% set FEEDER = params.FEEDER|default(0)|int %}
  {% set DIST   = params.DIST|default(10.0)|float %}
  {% set SPEED  = params.SPEED|default(50.0)|float %}   # mm/s (optional)

  {action_respond_info("OPENFEEDER_MOVE feeder=%d dist=%.3fmm speed=%.1fmm/s" % (FEEDER, DIST, SPEED))}
  {action_call_remote_method("openfeeder_move", feeder=FEEDER, dist_mm=DIST, speed_mms=SPEED)}


[gcode_macro OPENFEEDER_MOVE_UNTIL]
description: Move feeder by distance mm OR stop earlier when sensor hits target state
gcode:
  {% set FEEDER  = params.FEEDER|default(0)|int %}
  {% set DIST    = params.DIST|default(100.0)|float %}
  {% set SENSOR  = params.SENSOR|default("post-gear")|string %}
  {% set SPEED   = params.SPEED|default(50.0)|float %}      # mm/s
  {% set TIMEOUT = params.TIMEOUT|default(15.0)|float %}    # seconds
  {% set TARGET  = params.TARGET|default(1)|int %}          # 1=stop when TRUE, 0=stop when FALSE

  {action_respond_info("OPENFEEDER_MOVE_UNTIL feeder=%d dist=%.2fmm sensor=%s speed=%.1fmm/s target=%d timeout=%.1fs" %
    (FEEDER, DIST, SENSOR, SPEED, TARGET, TIMEOUT))}

  {action_call_remote_method("openfeeder_move_until",
      feeder=FEEDER,
      dist_mm=DIST,
      sensor=SENSOR,
      speed_mms=SPEED,
      timeout_s=TIMEOUT,
      target=TARGET)}

[gcode_macro BUFFER_COMPRESSED_ASSIST]
variable_dist: 20.0
variable_speed: 25.0
gcode:
  {% if printer.print_stats.state != "printing" %}
    RESPOND PREFIX=OPENFEEDER MSG="BufferAssist ignored (not printing)"
  {% endif %}

  {% set feeder = printer.save_variables.variables.active_tool|default(0)|int %}
  OPENFEEDER_MOVE FEEDER={feeder} DIST={dist} SPEED={speed}


[gcode_macro FEEDER_UNLOAD_TO_HUB]
variable_unload_max: 1000.0
variable_unload_extra: 8.0
variable_speed: 35.0
variable_timeout: 20.0
gcode:
  {% set feeder = params.FEEDER|int %}
  {% set max_mm = unload_max|float %}
  {% set extra_mm = unload_extra|float %}
  {% set spd = speed|float %}
  {% set tout = timeout|float %}

  ; Retract until hub triggers
  OPENFEEDER_MOVE_UNTIL FEEDER={feeder} DIST=-{max_mm} SENSOR=hub TARGET=1 SPEED={spd} TIMEOUT={tout}

  ; Extra retract
  OPENFEEDER_MOVE FEEDER={feeder} DIST=-{extra_mm} SPEED={spd}

  SAVE_VARIABLE VARIABLE=active_tool VALUE=-1

  ; Mark T{feeder} inactive
  {% set tname = "T" ~ feeder %}
  SET_GCODE_VARIABLE MACRO={tname} VARIABLE=active VALUE=False


[gcode_macro FEEDER_LOAD_TO_HUB_AND_EXPANDED]
variable_load_to_hub_max: 1000.0
variable_load_to_hub_extra: 4.0
variable_load_to_expanded_max: 400.0
variable_speed: 35.0
variable_timeout_hub: 20.0
variable_timeout_expanded: 30.0
gcode:
  {% set feeder = params.FEEDER|int %}

  {% set to_hub_max = load_to_hub_max|float %}
  {% set to_hub_extra = load_to_hub_extra|float %}
  {% set to_expanded_max = load_to_expanded_max|float %}
  {% set spd = speed|float %}
  {% set tout_hub = timeout_hub|float %}
  {% set tout_exp = timeout_expanded|float %}

  ; Feed until hub triggers
  OPENFEEDER_MOVE_UNTIL FEEDER={feeder} DIST={to_hub_max} SENSOR=hub TARGET=1 SPEED={spd} TIMEOUT={tout_hub}

  ; Small extra push
  OPENFEEDER_MOVE FEEDER={feeder} DIST={to_hub_extra} SPEED={spd}

  ; Continue until buffer expanded
  OPENFEEDER_MOVE_UNTIL FEEDER={feeder} DIST={to_expanded_max} SENSOR=buffer_expanded TARGET=1 SPEED={spd} TIMEOUT={tout_exp}

  SAVE_VARIABLE VARIABLE=active_tool VALUE={feeder}

  {% set tname = "T" ~ feeder %}
  SET_GCODE_VARIABLE MACRO={tname} VARIABLE=active VALUE=True



[delayed_gcode INIT_STATE]
initial_duration: 1.0
gcode:
  {% set cur = printer.save_variables.variables.active_tool|default(-1)|int %}
  {% if cur == -1 %}
    RESPOND MSG="No active tool"
  {% else %}
    {% set tname = "T" ~ cur %}
    SET_GCODE_VARIABLE MACRO={tname} VARIABLE=active VALUE=True
    RESPOND MSG={"Active tool is: " ~ tname}
  {% endif %}
######################################################################################################################
###  CLOSE / OPEN
######################################################################################################################

[gcode_macro T0]
variable_active: False
gcode:
  {% set new = 0 %}
  {% set cur = printer.save_variables.variables.active_tool|default(-1)|int %}
  {% if cur == new %}
    RESPOND PREFIX=OPENFEEDER MSG="T0 already active"
  {% endif %}

  {% if cur != -1 %}
    FEEDER_UNLOAD_TO_HUB FEEDER={cur}
  {% endif %}

  FEEDER_LOAD_TO_HUB_AND_EXPANDED FEEDER={new}
  RESPOND PREFIX=OPENFEEDER MSG="T0 complete"


[gcode_macro T1]
variable_active: False
gcode:
  {% set new = 1 %}
  {% set cur = printer.save_variables.variables.active_tool|default(-1)|int %}
  {% if cur == new %}
    RESPOND PREFIX=OPENFEEDER MSG="T1 already active"
  {% endif %}

  {% if cur != -1 %}
    FEEDER_UNLOAD_TO_HUB FEEDER={cur}
  {% endif %}

  FEEDER_LOAD_TO_HUB_AND_EXPANDED FEEDER={new}
  RESPOND PREFIX=OPENFEEDER MSG="T1 complete"




 